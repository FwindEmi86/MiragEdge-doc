"use strict";(self.webpackChunkdoc_web=self.webpackChunkdoc_web||[]).push([[32],{4959:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>o,default:()=>m,frontMatter:()=>i,metadata:()=>t,toc:()=>c});const t=JSON.parse('{"id":"study/dockercloud","title":"2023\u56fd\u8d5b\u7b2c\u4e5d\u5957\u8bd5\u5377","description":"\u3010\u4efb\u52a14\u3011Kubernetes\u5bb9\u5668\u4e91\u5e73\u53f0\u642d\u5efa[5.0\u5206]","source":"@site/docs/study/dockercloud.md","sourceDirName":"study","slug":"/study/dockercloud","permalink":"/study/dockercloud","draft":false,"unlisted":false,"tags":[],"version":"current","lastUpdatedAt":null,"frontMatter":{}}');var a=n(4848),s=n(8453);const i={},o="2023\u56fd\u8d5b\u7b2c\u4e5d\u5957\u8bd5\u5377",l={},c=[{value:"\u3010\u4efb\u52a14\u3011Kubernetes\u5bb9\u5668\u4e91\u5e73\u53f0\u642d\u5efa[5.0\u5206]",id:"\u4efb\u52a14kubernetes\u5bb9\u5668\u4e91\u5e73\u53f0\u642d\u5efa50\u5206",level:2},{value:"\u3010\u9002\u7528\u5e73\u53f0\u3011\u79c1\u6709\u4e91",id:"\u9002\u7528\u5e73\u53f0\u79c1\u6709\u4e91",level:3},{value:"\u3010\u9898\u76ee1\u30112.1.1 \u90e8\u7f72\u5bb9\u5668\u4e91\u5e73\u53f0[5.0\u5206]",id:"\u9898\u76ee1211-\u90e8\u7f72\u5bb9\u5668\u4e91\u5e73\u53f050\u5206",level:3},{value:"\u68c0\u6d4b\uff1a",id:"\u68c0\u6d4b",level:3},{value:"\u3010\u4efb\u52a15\u3011Kubernetes\u5bb9\u5668\u4e91\u670d\u52a1\u8fd0\u7ef4[10.0\u5206]",id:"\u4efb\u52a15kubernetes\u5bb9\u5668\u4e91\u670d\u52a1\u8fd0\u7ef4100\u5206",level:2},{value:"\u3010\u9002\u7528\u5e73\u53f0\u3011\u79c1\u6709\u4e91",id:"\u9002\u7528\u5e73\u53f0\u79c1\u6709\u4e91-1",level:3},{value:"\u3010\u9898\u76ee1\u30112.2.1 \u5bb9\u5668\u5316\u90e8\u7f72MariaDB [0.5\u5206]",id:"\u9898\u76ee1221-\u5bb9\u5668\u5316\u90e8\u7f72mariadb-05\u5206",level:3},{value:"\u68c0\u6d4b\uff1a",id:"\u68c0\u6d4b-1",level:3},{value:"\u68c0\u6d4b\u70b9\uff1a",id:"\u68c0\u6d4b\u70b9",level:3},{value:"\u3010\u9898\u76ee2\u30112.2.2 \u5bb9\u5668\u5316\u90e8\u7f72Redis [0.5\u5206]",id:"\u9898\u76ee2222-\u5bb9\u5668\u5316\u90e8\u7f72redis-05\u5206",level:3},{value:"\u68c0\u6d4b\uff1a",id:"\u68c0\u6d4b-2",level:3},{value:"\u68c0\u6d4b\u70b9\uff1a",id:"\u68c0\u6d4b\u70b9-1",level:3},{value:"\u3010\u9898\u76ee3\u30112.2.3 \u5bb9\u5668\u5316\u90e8\u7f72Nginx [0.5\u5206]",id:"\u9898\u76ee3223-\u5bb9\u5668\u5316\u90e8\u7f72nginx-05\u5206",level:3},{value:"\u68c0\u6d4b\uff1a",id:"\u68c0\u6d4b-3",level:3},{value:"\u68c0\u6d4b\u70b9\uff1a",id:"\u68c0\u6d4b\u70b9-2",level:3},{value:"\u3010\u9898\u76ee4\u30112.2.4 \u5bb9\u5668\u5316\u90e8\u7f72ERP [0.5\u5206]",id:"\u9898\u76ee4224-\u5bb9\u5668\u5316\u90e8\u7f72erp-05\u5206",level:3},{value:"\u68c0\u6d4b\uff1a",id:"\u68c0\u6d4b-4",level:3},{value:"\u68c0\u6d4b\u70b9\uff1a",id:"\u68c0\u6d4b\u70b9-3",level:3},{value:"\u3010\u9898\u76ee5\u30112.2.5 \u7f16\u6392\u90e8\u7f72ERP\u7ba1\u7406\u7cfb\u7edf[1.0\u5206]",id:"\u9898\u76ee5225-\u7f16\u6392\u90e8\u7f72erp\u7ba1\u7406\u7cfb\u7edf10\u5206",level:3},{value:"\u68c0\u6d4b\uff1a",id:"\u68c0\u6d4b-5",level:3},{value:"\u68c0\u6d4b\u70b9\uff1a",id:"\u68c0\u6d4b\u70b9-4",level:3},{value:"\u3010\u9898\u76ee6\u30112.2.6 \u90e8\u7f72GitLab [1.0\u5206]",id:"\u9898\u76ee6226-\u90e8\u7f72gitlab-10\u5206",level:3},{value:"\u8bbf\u95eeGitlab\uff1a",id:"\u8bbf\u95eegitlab",level:3},{value:"\u521b\u5efa\u9879\u76ee\uff1a",id:"\u521b\u5efa\u9879\u76ee",level:3},{value:"\u68c0\u67e5\uff1a",id:"\u68c0\u67e5",level:3},{value:"\u68c0\u67e5\u70b9\uff1a",id:"\u68c0\u67e5\u70b9",level:3},{value:"\u68c0\u67e5\uff1a",id:"\u68c0\u67e5-1",level:3},{value:"\u68c0\u67e5\u70b9\uff1a",id:"\u68c0\u67e5\u70b9-1",level:3},{value:"\u3010\u9898\u76ee7\u30112.2.7 \u90e8\u7f72GitLab Runner [1.0\u5206]",id:"\u9898\u76ee7227-\u90e8\u7f72gitlab-runner-10\u5206",level:3},{value:"\u3010\u9898\u76ee8\u30112.2.8 \u90e8\u7f72GitLab Agent [1.0\u5206]",id:"\u9898\u76ee8228-\u90e8\u7f72gitlab-agent-10\u5206",level:3},{value:"\u3010\u9898\u76ee9\u30112.2.9 \u6784\u5efaCI/CD [2.0\u5206]",id:"\u9898\u76ee9229-\u6784\u5efacicd-20\u5206",level:3}];function d(e){const r={br:"br",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",img:"img",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(r.header,{children:(0,a.jsx)(r.h1,{id:"2023\u56fd\u8d5b\u7b2c\u4e5d\u5957\u8bd5\u5377",children:"2023\u56fd\u8d5b\u7b2c\u4e5d\u5957\u8bd5\u5377"})}),"\n",(0,a.jsx)(r.h2,{id:"\u4efb\u52a14kubernetes\u5bb9\u5668\u4e91\u5e73\u53f0\u642d\u5efa50\u5206",children:"\u3010\u4efb\u52a14\u3011Kubernetes\u5bb9\u5668\u4e91\u5e73\u53f0\u642d\u5efa[5.0\u5206]"}),"\n",(0,a.jsx)(r.h3,{id:"\u9002\u7528\u5e73\u53f0\u79c1\u6709\u4e91",children:"\u3010\u9002\u7528\u5e73\u53f0\u3011\u79c1\u6709\u4e91"}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee1211-\u90e8\u7f72\u5bb9\u5668\u4e91\u5e73\u53f050\u5206",children:"\u3010\u9898\u76ee1\u30112.1.1 \u90e8\u7f72\u5bb9\u5668\u4e91\u5e73\u53f0[5.0\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u4f7f\u7528OpenStack\u79c1\u6709\u4e91\u5e73\u53f0\u521b\u5efa\u4e24\u53f0\u4e91\u4e3b\u673a\uff0c\u5206\u522b\u4f5c\u4e3aKubernetes\u96c6\u7fa4\u7684master\u8282\u70b9\u548cnode\u8282\u70b9\uff0c\u7136\u540e\u5b8c\u6210Kubernetes\u96c6\u7fa4\u7684\u90e8\u7f72\uff0c\u5e76\u5b8c\u6210Istio\u670d\u52a1\u7f51\u683c\u3001KubeVirt\u865a\u62df\u5316\u548cHarbor\u955c\u50cf\u4ed3\u5e93\u7684\u90e8\u7f72\u3002\u5b8c\u6210\u540e\u63d0\u4ea4master\u8282\u70b9\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801\u548cIP\u5230\u7b54\u9898\u6846\u3002"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@xzy-master ~]# curl -O http://172.29.20.222/2023/competition/chinaskills_cloud_paas_v2.1.iso\r\n\r\n[root@xzy-master ~]# mount -o loop chinaskills_cloud_paas_v2.1.iso /mnt/\r\nmount: /dev/loop0 is write-protected, mounting read-only\r\n\r\n[root@xzy-master ~]# cp -rvf /mnt/* /opt/\r\n\r\n[root@xzy-master ~]# umount /mnt/\r\n\r\n[root@xzy-master ~]# cp -rvf /opt/kubeeasy-v2.0 /usr/local/bin/\r\n\r\n[root@xzy-master ~]# kubeeasy-v2.0 install dependencies \\\r\n> --host 172.29.20.207,172.29.20.236 --user root \\\r\n> --password 000000 \\\r\n> --offline-file /opt/dependencies/packages.tar.gz \r\n\r\n[root@xzy-master ~]# kubeeasy-v2.0 install kubernetes \\\r\n> --master 172.29.20.207 --worker 172.29.20.236 --user root \\\r\n> --password 000000 \\\r\n> --version 1.25.2 \\\r\n> --offline-file /opt/kubeeasy.tar.gz\r\n\r\n[root@xzy-master ~]# kubeeasy-v2.0 create ssh-keygen \\\r\n> --master 172.29.20.207 --worker 172.29.20.236 --user root \\\r\n> --password 000000\r\n\r\n[root@k8s-master-node1 ~]# vi /etc/docker/daemon.json\r\n{\r\n  "insecure-registries": ["0.0.0.0/0"]\r\n}\r\n\r\n[root@k8s-master-node1 ~]# systemctl daemon-reload \r\n\r\n[root@k8s-master-node1 ~]# systemctl restart docker\r\n\r\n[root@k8s-master-node1 ~]# docker login -uadmin -pHarbor12345 172.29.20.207\r\nWARNING! Using --password via the CLI is insecure. Use --password-stdin.\r\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\r\nConfigure a credential helper to remove this warning. See\r\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\r\n\r\nLogin Succeeded\n'})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b",children:"\u68c0\u6d4b\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"[root@k8s-master-node1 ~]# kubectl cluster-info\r\nKubernetes control plane is running at https://apiserver.cluster.local:6443\r\nCoreDNS is running at https://apiserver.cluster.local:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\r\n\r\nTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.\r\n\r\n[root@k8s-master-node1 ~]# kubectl -n istio-system get all\r\nWarning: kubevirt.io/v1 VirtualMachineInstancePresets is now deprecated and will be removed in v2.\r\nNAME                                        READY   STATUS    RESTARTS   AGE\r\npod/grafana-56bdf8bf85-gv5lv                1/1     Running   0          82m\r\npod/istio-egressgateway-fffc799cf-r49f9     1/1     Running   0          82m\r\npod/istio-ingressgateway-7d68764b55-pdfb2   1/1     Running   0          82m\r\npod/istiod-5456fd558d-tmk5h                 1/1     Running   0          82m\r\npod/jaeger-c4fdf6674-h68tp                  1/1     Running   0          82m\r\npod/kiali-8f955f859-wx9xz                   1/1     Running   0          82m\r\npod/prometheus-85949fddb-m4gk5              2/2     Running   0          82m\r\n\r\nNAME                           TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                         AGE\r\nservice/grafana                NodePort       10.96.250.173   <none>        3000:33000/TCP                  82m\r\nservice/istio-egressgateway    ClusterIP      10.96.170.36    <none>        80/TCP,443/TCP                  82m\r\nservice/istio-ingressgateway   LoadBalancer   10.96.180.24    <pending>     15021:60350/TCP,80:21669/TCP,443:2758/TCP,31400:860/TCP,15443:36161/TCP   82m\r\nservice/istiod                 ClusterIP      10.96.201.73    <none>        15010/TCP,15012/TCP,443/TCP,15014/TCP                                     82m\r\nservice/jaeger-collector       ClusterIP      10.96.189.191   <none>        14268/TCP,14250/TCP,9411/TCP   82m\r\nservice/kiali                  NodePort       10.96.106.156   <none>        20001:30001/TCP,9090:39091/TCP 82m\r\nservice/prometheus             NodePort       10.96.103.86    <none>        9090:39090/TCP                  82m\r\nservice/tracing                NodePort       10.96.228.55    <none>        80:36686/TCP,16685:36685/TCP   82m\r\nservice/zipkin                 NodePort       10.96.4.187     <none>        9411:39411/TCP                  82m\r\n\r\nNAME                                   READY   UP-TO-DATE   AVAILABLE   AGE\r\ndeployment.apps/grafana                1/1     1            1           82m\r\ndeployment.apps/istio-egressgateway    1/1     1            1           82m\r\ndeployment.apps/istio-ingressgateway   1/1     1            1           82m\r\ndeployment.apps/istiod                 1/1     1            1           82m\r\ndeployment.apps/jaeger                 1/1     1            1           82m\r\ndeployment.apps/kiali                  1/1     1            1           82m\r\ndeployment.apps/prometheus             1/1     1            1           82m\r\n\r\nNAME                                              DESIRED   CURRENT   READY   AGE\r\nreplicaset.apps/grafana-56bdf8bf85                1         1         1       82m\r\nreplicaset.apps/istio-egressgateway-fffc799cf     1         1         1       82m\r\nreplicaset.apps/istio-ingressgateway-7d68764b55   1         1         1       82m\r\nreplicaset.apps/istiod-5456fd558d                 1         1         1       82m\r\nreplicaset.apps/jaeger-c4fdf6674                  1         1         1       82m\r\nreplicaset.apps/kiali-8f955f859                   1         1         1       82m\r\nreplicaset.apps/prometheus-85949fddb              1         1         1       82m\r\n\r\n[root@k8s-master-node1 ~]# kubectl -n kubevirt get deployment\r\nNAME              READY   UP-TO-DATE   AVAILABLE   AGE\r\nvirt-api          2/2     2            2           84m\r\nvirt-controller   2/2     2            2           83m\r\nvirt-operator     2/2     2            2           84m\r\n\r\n[root@k8s-master-node1 ~]# docker login -u admin -p Harbor12345 $(hostname -i)\r\nWARNING! Using --password via the CLI is insecure. Use --password-stdin.\r\nWARNING! Your password will be stored unencrypted in /root/.docker/config.json.\r\nConfigure a credential helper to remove this warning. See\r\nhttps://docs.docker.com/engine/reference/commandline/login/#credentials-store\r\n\r\nLogin Succeeded\n"})}),"\n",(0,a.jsx)(r.h2,{id:"\u4efb\u52a15kubernetes\u5bb9\u5668\u4e91\u670d\u52a1\u8fd0\u7ef4100\u5206",children:"\u3010\u4efb\u52a15\u3011Kubernetes\u5bb9\u5668\u4e91\u670d\u52a1\u8fd0\u7ef4[10.0\u5206]"}),"\n",(0,a.jsx)(r.h3,{id:"\u9002\u7528\u5e73\u53f0\u79c1\u6709\u4e91-1",children:"\u3010\u9002\u7528\u5e73\u53f0\u3011\u79c1\u6709\u4e91"}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee1221-\u5bb9\u5668\u5316\u90e8\u7f72mariadb-05\u5206",children:"\u3010\u9898\u76ee1\u30112.2.1 \u5bb9\u5668\u5316\u90e8\u7f72MariaDB [0.5\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u7f16\u5199Dockerfile\u6587\u4ef6\u6784\u5efamysql\u955c\u50cf\uff0c\u8981\u6c42\u57fa\u4e8ecentos\u5b8c\u6210MariaDB\u6570\u636e\u5e93\u7684\u5b89\u88c5\u548c\u914d\u7f6e\uff0c\u5e76\u8bbe\u7f6e\u670d\u52a1\u5f00\u673a\u81ea\u542f\u3002\u5b8c\u6210\u540e\u6784\u5efa\u955c\u50cf\uff0c\u5e76\u63d0\u4ea4master\u8282\u70b9\u7684IP\u5730\u5740\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u5230\u7b54\u9898\u6846\u3002"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"[root@k8s-master-node1 ~]# curl -O http://172.29.20.222/2023/competition/ERP.tar.gz\r\n\r\n[root@k8s-master-node1 ~]# tar -xzvf ERP.tar.gz\r\n\u2026\u2026\r\n\r\n[root@k8s-master-node1 ~]# cd ERP/\r\n\r\n[root@k8s-master-node1 ERP]# docker load -i CentOS_7.9.2009.tar \r\n\r\n[root@k8s-master-node1 ERP]# vi local.repo\r\n[yum]\r\nname=yum\r\nbaseurl=file:///root/yum\r\nenabled=1\r\ngpgcheck=0\r\n\r\n[root@k8s-master-node1 ERP]# vi Dockerfile-mysql\r\nFROM centos:centos7.9.2009\r\nMAINTAINER Chinaskills\r\nRUN rm -rf /etc/yum.repos.d/*\r\nCOPY local.repo /etc/yum.repos.d/\r\nCOPY yum /root/yum\r\nENV LC_ALL en_US.UTF-8\r\nRUN yum install -y mariadb-server\r\nCOPY jsh_erp.sql /root/\r\nCOPY mysql_init.sh /root/\r\nRUN sh /root/mysql_init.sh\r\nEXPOSE 3306\r\nCMD [\"mysqld_safe\",\"--user=root\"]\r\n\r\n[root@k8s-master-node1 ERP]# vi mysql_init.sh \r\n#!/bin/bash\r\nmysql_install_db --user=root\r\nmysqld_safe --user=root & sleep 8\r\nmysqladmin -uroot password 'tshoperp'\r\nmysql -uroot -ptshoperp -e \"grant all on *.* to root@'%' identified by 'tshoperp';create database jsh_erp;use jsh_erp;source /root/jsh_erp.sql;\"\r\n\r\n[root@k8s-master-node1 ERP]# docker build -t erp-mysql:v1.0 -f Dockerfile-mysql .\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b-1",children:"\u68c0\u6d4b\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 ERP]# docker run -d --name mariadb-exam-jiance erp-mysql:v1.0 && sleep 15 && docker exec mariadb-exam-jiance mysql -uroot -ptshoperp -e "show databases" && docker rm -f mariadb-exam-jiance   \r\n7bfb08605ac1dcf083ef3da985ea0fd09aad2c6ffe96c431da4f4c1c69f74ae6\r\nDatabase\r\ninformation_schema\r\njsh_erp\r\nmysql\r\nperformance_schema\r\ntest\r\nmariadb-exam-jiance\n'})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b\u70b9",children:"\u68c0\u6d4b\u70b9\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"jsh_erp\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee2222-\u5bb9\u5668\u5316\u90e8\u7f72redis-05\u5206",children:"\u3010\u9898\u76ee2\u30112.2.2 \u5bb9\u5668\u5316\u90e8\u7f72Redis [0.5\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u7f16\u5199Dockerfile\u6587\u4ef6\u6784\u5efaredis\u955c\u50cf\uff0c\u8981\u6c42\u57fa\u4e8ecentos\u5b8c\u6210Redis\u670d\u52a1\u7684\u5b89\u88c5\u548c\u914d\u7f6e\uff0c\u5e76\u8bbe\u7f6e\u670d\u52a1\u5f00\u673a\u81ea\u542f\u3002\u5b8c\u6210\u540e\u6784\u5efa\u955c\u50cf\uff0c\u5e76\u63d0\u4ea4master\u8282\u70b9\u7684IP\u5730\u5740\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u5230\u7b54\u9898\u6846\u3002"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 ERP]# vim Dockerfile-redis\r\nFROM centos:centos7.9.2009\r\nMAINTAINER Chinaskills\r\nRUN rm -rf /etc/yum.repos.d/*\r\nCOPY local.repo /etc/yum.repos.d/\r\nCOPY yum /root/yum\r\nRUN yum -y install redis\r\nRUN sed -i \'/bind/s/127.0.0.1/0.0.0.0/;/-mode/s/yes/no/\' /etc/redis.conf\r\nEXPOSE 6379\r\nCMD ["redis-server","/etc/redis.conf"]\r\n\r\n[root@k8s-master-node1 ERP]# docker build -t erp-redis:v1.0 -f Dockerfile-redis .\n'})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b-2",children:"\u68c0\u6d4b\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"[root@k8s-master-node1 ERP]# docker run -d --name redis-exam-jiance erp-redis:v1.0 && sleep 10 && docker exec redis-exam-jiance redis-cli -p 6379 info && docker rm -f redis-exam-jiance\r\n431846511da147fdc3c6cfb3397025d6232ca25719b70ea8f577bddf3720288c\r\n# Server\r\nredis_version:3.2.12\r\nredis_git_sha1:00000000\r\nredis_git_dirty:0\r\nredis_build_id:7897e7d0e13773f\r\nredis_mode:standalone\r\nos:Linux 3.10.0-1160.el7.x86_64 x86_64\r\narch_bits:64\r\nmultiplexing_api:epoll\r\ngcc_version:4.8.5\r\nprocess_id:1\r\nrun_id:9229aeae81e85c7df857fb861491e98627ec0e83\r\ntcp_port:6379\r\nuptime_in_seconds:10\r\nuptime_in_days:0\r\nhz:10\r\nlru_clock:10912960\r\nexecutable:/redis-server\r\nconfig_file:/etc/redis.conf\r\n\u2026\u2026\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b\u70b9-1",children:"\u68c0\u6d4b\u70b9\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"redis_version:3.2.12 && redis_mode:standalone\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee3223-\u5bb9\u5668\u5316\u90e8\u7f72nginx-05\u5206",children:"\u3010\u9898\u76ee3\u30112.2.3 \u5bb9\u5668\u5316\u90e8\u7f72Nginx [0.5\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u7f16\u5199Dockerfile\u6587\u4ef6\u6784\u5efanginx\u955c\u50cf\uff0c\u8981\u6c42\u57fa\u4e8ecentos\u5b8c\u6210Nginx\u670d\u52a1\u7684\u5b89\u88c5\u548c\u914d\u7f6e\uff0c\u5e76\u8bbe\u7f6e\u670d\u52a1\u5f00\u673a\u81ea\u542f\u3002\u5b8c\u6210\u540e\u6784\u5efa\u955c\u50cf\uff0c\u5e76\u63d0\u4ea4master\u8282\u70b9\u7684IP\u5730\u5740\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u5230\u7b54\u9898\u6846\u3002"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 ERP]# vim Dockerfile-nginx\r\nFROM centos:centos7.9.2009\r\nMAINTAINER Chinaskills\r\nRUN rm -rf /etc/yum.repos.d/*\r\nCOPY local.repo /etc/yum.repos.d/\r\nCOPY yum /root/yum\r\nRUN yum -y install nginx\r\nCOPY nginx/nginx.conf /etc/nginx/nginx.conf\r\nCOPY nginx/app.tar.gz /\r\nRUN tar -zxvf app.tar.gz -C /\r\nRUN /bin/bash -c "echo init ok"\r\nEXPOSE 80\r\nCMD ["nginx","-g","daemon off;"]\r\n\r\n[root@k8s-master-node1 ERP]# docker build -t erp-nginx:v1.0 -f Dockerfile-nginx .\n'})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b-3",children:"\u68c0\u6d4b\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 ERP]# docker rm -f nginx-exam-jiance > /dev/null 2>&1 && docker run -d --name=nginx-exam-jiance --restart=always erp-nginx:v1.0 && sleep 5s && docker logs nginx-exam-jiance && docker rm -f nginx-exam-jiance\r\n7d9340ce7b12c24a41da16cb25057a19d62252b59c4430efdd1df1dffa582be3\r\nnginx: [emerg] host not found in upstream "erp-server" in /etc/nginx/nginx.conf:24\r\nnginx: [emerg] host not found in upstream "erp-server" in /etc/nginx/nginx.conf:24\r\nnginx: [emerg] host not found in upstream "erp-server" in /etc/nginx/nginx.conf:24\r\nnginx: [emerg] host not found in upstream "erp-server" in /etc/nginx/nginx.conf:24\r\nnginx: [emerg] host not found in upstream "erp-server" in /etc/nginx/nginx.conf:24\r\nnginx: [emerg] host not found in upstream "erp-server" in /etc/nginx/nginx.conf:24\r\nnginx-exam-jiance\n'})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b\u70b9-2",children:"\u68c0\u6d4b\u70b9\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"erp-server\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee4224-\u5bb9\u5668\u5316\u90e8\u7f72erp-05\u5206",children:"\u3010\u9898\u76ee4\u30112.2.4 \u5bb9\u5668\u5316\u90e8\u7f72ERP [0.5\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u7f16\u5199Dockerfile\u6587\u4ef6\u6784\u5efaerp\u955c\u50cf\uff0c\u8981\u6c42\u57fa\u4e8ecentos\u5b8c\u6210JDK\u73af\u5883\u548cERP\u670d\u52a1\u7684\u5b89\u88c5\u4e0e\u914d\u7f6e\uff0c\u5e76\u8bbe\u7f6e\u670d\u52a1\u5f00\u673a\u81ea\u542f\u3002\u5b8c\u6210\u540e\u6784\u5efa\u955c\u50cf\uff0c\u5e76\u63d0\u4ea4master\u8282\u70b9\u7684IP\u5730\u5740\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u5230\u7b54\u9898\u6846\u3002"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"[root@k8s-master-node1 ERP]# vim Dockerfile-erp\r\nFROM centos:centos7.9.2009\r\nMAINTAINER Chinaskills\r\nRUN rm -rf /etc/yum.repos.d/*\r\nCOPY local.repo /etc/yum.repos.d/\r\nCOPY yum /root/yum\r\nRUN yum -y install java-1.8.0-openjdk java-1.8.0-openjdk-devel\r\nCOPY app.jar /root/\r\nEXPOSE 9999\r\nCMD java -jar /root/app.jar\r\n\r\n[root@k8s-master-node1 ERP]# docker build -t erp-service:v1.0 -f Dockerfile-erp .\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b-4",children:"\u68c0\u6d4b\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 ERP]# docker run -d --name erp-exam-jiance --restart=always erp-server:v1.0 && docker exec erp-exam-jiance java -version && docker exec erp-exam-jiance ps -aux && docker rm -f erp-exam-jiance\r\n370e4a6d516f732e0a42664c1bdd944517673ef5ece5cbc41ce68b41cd159efb\r\nopenjdk version "1.8.0_312"\r\nOpenJDK Runtime Environment (build 1.8.0_312-b07)\r\nOpenJDK 64-Bit Server VM (build 25.312-b07, mixed mode)\r\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\r\nroot         1  0.0  0.2 6526132 43240 ?       Ssl  13:56   0:00 java -jar /root/app.jar\r\nroot        41  0.0  0.0  51732  1696 ?        Rs   13:56   0:00 ps -aux\r\nerp-exam-jiance\n'})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b\u70b9-3",children:"\u68c0\u6d4b\u70b9\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"1.8.0_312 && app.jar\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee5225-\u7f16\u6392\u90e8\u7f72erp\u7ba1\u7406\u7cfb\u7edf10\u5206",children:"\u3010\u9898\u76ee5\u30112.2.5 \u7f16\u6392\u90e8\u7f72ERP\u7ba1\u7406\u7cfb\u7edf[1.0\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u7f16\u5199docker-compose.yaml\u6587\u4ef6\uff0c\u8981\u6c42\u4f7f\u7528\u955c\u50cfmysql\u3001redis\u3001nginx\u548cerp\u5b8c\u6210ERP\u7ba1\u7406\u7cfb\u7edf\u7684\u7f16\u6392\u90e8\u7f72\u3002\u5b8c\u6210\u540e\u7f16\u6392\u90e8\u7f72ERP\u7ba1\u7406\u7cfb\u7edf\uff0c\u7136\u540e\u63d0\u4ea4master\u8282\u70b9\u7684IP\u5730\u5740\u3001\u7528\u6237\u540d\u548c\u5bc6\u7801\u5230\u7b54\u9898\u6846\u3002"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"[root@k8s-master-node1 ERP]# vim docker-compose.yaml\r\nversion: '3'\r\nservices:\r\n  erp-mysql:\r\n    image: erp-mysql:v1.0\r\n    container_name: erp-mysql\r\n    ports:\r\n    - 3306:3306\r\n    environment:\r\n    - MYSQL_DATABASE=jsh_erp\r\n    restart: always\r\n  erp-redis:\r\n    image: erp-redis:v1.0\r\n    container_name: erp-redis\r\n    ports:\r\n    - 6379:6379\r\n    restart: always\r\n    command: redis-server --port 6379 --requirepass tshoperp --appendonly yes\r\n  erp-server:\r\n    image: erp-service:v1.0\r\n    container_name: erp-server\r\n    ports:\r\n    - 9999:9999\r\n    restart: always\r\n  erp-web-ui:\r\n    image: erp-nginx:v1.0\r\n    container_name: erp-nginx\r\n    ports:\r\n    - 8888:80\r\n    restart: always\r\n\r\n[root@k8s-master-node1 ERP]# docker-compose up -d\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b-5",children:"\u68c0\u6d4b\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"[root@k8s-master-node1 ERP]# curl -L $(hostname -i):8888\r\n\u2026\u2026\r\n    /* \u6eda\u52a8\u6761\u4f18\u5316 end */</style><script>function getPlatform(type) {\r\n      let res = '';\r\n      let ajax = new XMLHttpRequest();\r\n      let url = window._CONFIG['domianURL'] + '/platformConfig/getPlatform/' + type\r\n      ajax.onreadystatechange = function () {\r\n        if (ajax.readyState===4 &&ajax.status===200) {\r\n          res = ajax.responseText;\r\n        } else {\r\n          res = 'ERP\u7cfb\u7edf';\r\n        }\r\n      }\r\n      ajax.open('get', url, false);\r\n      ajax.send(null);\r\n      return res;\r\n    }\r\n    window._CONFIG = {};\r\n    window._CONFIG['domianURL'] = '/jshERP-boot';\r\n    // window._CONFIG['domianURL'] = 'https://sdyq-erp-t-api.debug-online.cn/jshERP-boot';\r\n    let statisticsCode = '1cd9bcbaae133f03a6eb19da6579aaba'\r\n    window.SYS_TITLE = getPlatform(\"name\");\r\n    window.SYS_URL = getPlatform(\"url\");\r\n    window._statistics = 'https://hm.baidu.com/hm.js?' + statisticsCode\r\n    document.title = window.SYS_TITLE;\r\n    //statistics\r\n    var _hmt = _hmt || [];\r\n    (function() {\r\n\u2026\u2026\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u6d4b\u70b9-4",children:"\u68c0\u6d4b\u70b9\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"ERP\u7cfb\u7edf\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee6226-\u90e8\u7f72gitlab-10\u5206",children:"\u3010\u9898\u76ee6\u30112.2.6 \u90e8\u7f72GitLab [1.0\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u5728Kubernetes\u96c6\u7fa4\u4e2d\u65b0\u5efa\u547d\u540d\u7a7a\u95f4gitlab-ci\uff0c\u5c06GitLab\u90e8\u7f72\u5230\u8be5\u547d\u540d\u7a7a\u95f4\u4e0b\uff0cDeployment\u548cService\u540d\u79f0\u5747\u4e3agitlab\uff0c\u4ee5NodePort\u65b9\u5f0f\u5c0680\u7aef\u53e3\u5bf9\u5916\u66b4\u9732\u4e3a30880\uff0c\u8bbe\u7f6eGitLab\u670d\u52a1root\u7528\u6237\u7684\u5bc6\u7801\u4e3aadmin@123\uff0c\u5c06\u9879\u76ee\u5305demo-2048.tar.gz\u5bfc\u5165\u5230GitLab\u4e2d\u5e76\u547d\u540d\u4e3ademo-2048\u3002\u5b8c\u6210\u540e\u63d0\u4ea4master\u8282\u70b9\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801\u548cIP\u5730\u5740\u5230\u7b54\u9898\u6846\u3002\uff08\u9700\u8981\u7528\u5230\u7684\u8f6f\u4ef6\u5305\uff1aCICD-Runner.tar.gz\uff09"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"[root@k8s-master-node1 ~]# curl -O http://172.29.20.222/2023/competition/Gitlab-CI.tar.gz\r\n\r\n[root@k8s-master-node1 ~]# tar -xzvf Gitlab-CI.tar.gz\r\n\r\n[root@k8s-master-node1 ~]# scp gitlab-ci/images/images.tar k8s-worker-node1:/root/\r\n\r\n[root@k8s-master-node1 ~]# ctr -n k8s.io image import gitlab-ci/images/images.tar  \r\n\r\n[root@k8s-worker-node1 ~]# ctr -n k8s.io image import images.tar\r\n\r\n[root@k8s-master-node1 ~]# kubectl create ns gitlab-ci\r\n\r\n[root@k8s-master-node1 ~]# cd gitlab-ci/   \r\n\r\n[root@k8s-master-node1 gitlab-ci]# vi gitlab-deploy.yaml \r\napiVersion: apps/v1\r\nkind: Deployment\r\nmetadata:\r\n  labels:\r\n    name: gitlab\r\n  name: gitlab\r\n  namespace: gitlab-ci\r\nspec:\r\n  selector:\r\n    matchLabels:\r\n      name: gitlab\r\n  template:\r\n    metadata:\r\n      name: gitlab\r\n      labels:\r\n        name: gitlab\r\n    spec:\r\n      containers:\r\n      - image: docker.io/gitlab/gitlab-ce:latest\r\n        name: gitlab\r\n        imagePullPolicy: IfNotPresent\r\n        env:\r\n        - name: GITLAB_ROOT_PASSWORD\r\n          value: Abc@1234\r\n        - name: GITLAB_ROOT_EMAIL\r\n          value: 123456@qq.com\r\n        ports:\r\n        - name: http\r\n          containerPort: 80\r\n        volumeMounts:\r\n        - name: gitlab-config\r\n          mountPath: /etc/gitlab\r\n        - name: gitlab-logs\r\n          mountPath: /var/log/gitlab\r\n        - name: gitlab-data\r\n          mountPath: /var/opt/gitlab\r\n      volumes:\r\n      - name: gitlab-config\r\n        hostPath:\r\n          path: /home/gitlab/conf\r\n      - name: gitlab-logs\r\n        hostPath:\r\n          path: /home/gitlab/logs\r\n      - name: gitlab-data\r\n        hostPath:\r\n          path: /home/gitlab/data\r\n---\r\napiVersion: v1\r\nkind: Service\r\nmetadata:\r\n  labels:\r\n    name: gitlab\r\n  name: gitlab\r\n  namespace: gitlab-ci\r\nspec:\r\n  type: NodePort\r\n  ports:\r\n  - name: http\r\n    port: 80\r\n    targetPort: http\r\n    nodePort: 30880\r\n  selector:\r\n    name: gitlab\r\n\r\n[root@k8s-master-node1 gitlab-ci]# kubectl apply -f gitlab-deploy.yaml\r\n\r\n[root@k8s-master-node1 ~]# kubectl -n gitlab-ci get all -owide\r\nWarning: kubevirt.io/v1 VirtualMachineInstancePresets is now deprecated and will be removed in v2.\r\nNAME                          READY   STATUS    RESTARTS   AGE   IP            NODE               NOMINATED NODE   READINESS GATES\r\npod/gitlab-5945f868c9-5gpsn   1/1     Running   0          4s    10.244.1.21   k8s-worker-node1   <none>           <none>\r\n\r\nNAME             TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE   SELECTOR\r\nservice/gitlab   NodePort   10.96.100.235   <none>        80:30880/TCP   4s    name=gitlab\r\n\r\nNAME                     READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS   IMAGES                              SELECTOR\r\ndeployment.apps/gitlab   1/1     1            1           4s    gitlab       docker.io/gitlab/gitlab-ce:latest   name=gitlab\r\n\r\nNAME                                DESIRED   CURRENT   READY   AGE   CONTAINERS   IMAGES                              SELECTOR\r\nreplicaset.apps/gitlab-5945f868c9   1         1         1       4s    gitlab       docker.io/gitlab/gitlab-ce:latest   name=gitlab,pod-template-hash=5945f868c9\r\n\r\n[root@k8s-master-node1 gitlab-ci]# kubectl -n kube-system edit configmaps coredns \r\n           fallthrough in-addr.arpa ip6.arpa\r\n           ttl 30\r\n        }\r\n        #\u6dfb\u52a0\r\n        hosts {\r\n            10.244.0.14 gitlab-5945f868c9-d5dff\r\n            fallthrough\r\n        }\r\n        prometheus :9153\r\n        forward . /etc/resolv.conf {\r\n           max_concurrent 1000\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u8bbf\u95eegitlab",children:"\u8bbf\u95eeGitlab\uff1a"}),"\n",(0,a.jsx)(r.p,{children:"root/Abc@1234"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/1",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/2",alt:"img"})]}),"\n",(0,a.jsxs)(r.p,{children:["#\u5982\u51fa\u73b0\u4ee5\u4e0b\u9875\u9762\u70b9\u51fb\u8fd9\u91cc\u5373\u53ef\r\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/3",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/4",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/5",alt:"img"})]}),"\n",(0,a.jsx)(r.h3,{id:"\u521b\u5efa\u9879\u76ee",children:"\u521b\u5efa\u9879\u76ee\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 ~]# cd gitlab-ci/demo-2048/\r\n\r\n[root@k8s-master-node1 demo-2048]# vi template/demo-2048.yaml\r\n    spec:\r\n      containers:\r\n        - name: demo-2048\r\n          image: 172.29.20.207/demo/demo:latest   #\u8fd9\u91cc\u6539\u4e3a\u672c\u673aIP\r\n          ports:\r\n            - containerPort: 8080\r\n              name: demo\r\n\r\n[root@k8s-master-node1 demo-2048]# vi Dockerfiles/Dockerfile\r\nFROM 172.29.20.207/library/tomcat:8.5.64-jdk8  #\u8fd9\u91cc\u6539\u4e3a\u672c\u673aIP\r\nRUN rm -rf /usr/local/tomcat/webapps/ROOT/\r\nADD 2048 /usr/local/tomcat/webapps/ROOT/\r\n\r\n[root@k8s-master-node1 demo-2048]# git config --global user.name "administrator"\r\n\r\n[root@k8s-master-node1 demo-2048]# git config --global user.email "admin@example.com"\r\n\r\n[root@k8s-master-node1 demo-2048]# git remote remove origin\r\n\r\n[root@k8s-master-node1 demo-2048]# git remote add origin http://172.29.20.207:30880/root/demo-2048.git\r\n\r\n[root@k8s-master-node1 demo-2048]# git add .\r\n\r\n[root@k8s-master-node1 demo-2048]# git commit -m "test"\r\n\r\n[root@k8s-master-node1 demo-2048]# git push -u origin drone\r\nUsername for \'http://172.29.20.207:30880\': root    #gitlab\u8d26\u6237\r\nPassword for \'http://root@172.29.20.207:30880\': #\u5bc6\u7801  Abc@1234\r\nCounting objects: 366, done.\r\nDelta compression using up to 8 threads.\r\nCompressing objects: 100% (182/182), done.\r\nWriting objects: 100% (366/366), 122.76 KiB | 0 bytes/s, done.\r\nTotal 366 (delta 162), reused 352 (delta 153)\r\nremote: Resolving deltas: 100% (162/162), done.\r\nremote: \r\nremote: To create a merge request for drone, visit:\r\nremote:   http://gitlab-5945f868c9-5gpsn/root/demo-2048/-/merge_requests/new?merge_request%5Bsource_branch%5D=drone\r\nremote: \r\nTo http://172.29.20.207:30880/root/demo-2048.git\r\n * [new branch]      drone -> drone\r\nBranch drone set up to track remote branch drone from origin.\n'})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u67e5",children:"\u68c0\u67e5\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"kubectl -n gitlab-ci exec deploy/gitlab -- gitlab-ctl service-list\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u67e5\u70b9",children:"\u68c0\u67e5\u70b9\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"prometheus* || gitlab-workhorse* || postgresql* || redis*\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u67e5-1",children:"\u68c0\u67e5\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"curl -L http://$(hostname -i):30880/admin\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u68c0\u67e5\u70b9-1",children:"\u68c0\u67e5\u70b9\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:"GitLab is a single application for the entire software development lifecycle\n"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee7227-\u90e8\u7f72gitlab-runner-10\u5206",children:"\u3010\u9898\u76ee7\u30112.2.7 \u90e8\u7f72GitLab Runner [1.0\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u5c06GitLab Runner\u90e8\u7f72\u5230gitlab-ci\u547d\u540d\u7a7a\u95f4\u4e0b\uff0cRelease\u540d\u79f0\u4e3agitlab-runner\uff0c\u4e3aGitLab Runner\u521b\u5efa\u6301\u4e45\u5316\u6784\u5efa\u7f13\u5b58\u76ee\u5f55/home/gitlab-runner/ci-build-cache\u4ee5\u52a0\u901f\u6784\u5efa\u901f\u5ea6\uff0c\u5e76\u5c06\u5176\u6ce8\u518c\u5230GitLab\u4e2d\u3002\u5b8c\u6210\u540e\u63d0\u4ea4master\u8282\u70b9\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801\u548cIP\u5730\u5740\u5230\u7b54\u9898\u6846\u3002\uff08\u9700\u8981\u7528\u5230\u7684\u8f6f\u4ef6\u5305\uff1aCICD-Runner.tar.gz\uff09"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 demo-2048]# cd ..\r\n\r\n[root@k8s-master-node1 gitlab-ci]# kubectl -n gitlab-ci create sa gitlab-ci\r\n\r\n[root@k8s-master-node1 gitlab-ci]# kubectl -n gitlab-ci create role --resource="*" --verb="*" gitlab-ci\r\n\r\n[root@k8s-master-node1 gitlab-ci]# kubectl -n gitlab-ci create rolebinding --role=gitlab-ci --serviceaccount=gitlab-ci:gitlab-ci gitlab-ci\r\n\r\n[root@k8s-master-node1 gitlab-ci]# kubectl create clusterrolebinding --clusterrole=cluster-admin --serviceaccount=gitlab-ci:default default\n'})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/6",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/7",alt:"img"})]}),"\n",(0,a.jsx)(r.p,{children:"#\u8fd9\u91cc\u53ef\u4ee5\u770b\u5230\u6ce8\u518c\u4ee4\u724c \u590d\u5236\u7b49\u4f1a\u9700\u8981\u7528\u5230"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/8",alt:"img"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 gitlab-ci]# tar -xzvf gitlab-runner-0.43.0.tgz\r\n\r\n#\u4fee\u6539values.yaml\u6587\u4ef6\r\n[root@master gitlab-ci]# vi gitlab-runner/values.yaml\r\n...\r\n  ## Use the following Kubernetes Service Account name if RBAC is disabled in this Helm chart (see rbac.create)\r\n  ##\r\n  # serviceAccountName: default\r\n  serviceAccountName: gitlab-ci   #\u6dfb\u52a0\uff0c\u6ce8\u610f\u7f29\u8fdb\u683c\u5f0f\r\n... \r\n\r\n## The GitLab Server URL (with protocol) that want to register the runner against\r\n## ref: https://docs.gitlab.com/runner/commands/index.html#gitlab-runner-register\r\n##\r\n# gitlabUrl: http://gitlab.your-domain.com/\r\ngitlabUrl: http://10.24.2.14:30880/      #\u6dfb\u52a0\uff0c\u7f29\u8fdb\u9876\u683c\r\n...\r\n## The Registration Token for adding new Runners to the GitLab Server. This must\r\n## be retrieved from your GitLab Instance.\r\n## ref: https://docs.gitlab.com/ce/ci/runners/index.html\r\n##\r\n# runnerRegistrationToken: "" \r\nrunnerRegistrationToken: "riU8c4D2SNkKAv8GS9q_"  #\u8fd9\u91cc\u4f7f\u7528\u7684\u662f\u4e0a\u9762\u590d\u5236\u7684token\r\n...\r\n  config: |\r\n    [[runners]]\r\n      [runners.kubernetes]\r\n        namespace = "{{.Release.Namespace}}"\r\n        image = "ubuntu:16.04"\r\n        privileged = true     #\u6dfb\u52a0\uff0c\u6ce8\u610f\u7f29\u8fdb\u683c\u5f0f\r\n\r\n#\u521b\u5efa\u4e00\u4e2aPVC\u7528\u4e8e\u6302\u8f7d\u5230Pod\u4e2d\u4f7f\u7528\uff1a\r\n[root@k8s-master-node1 gitlab-ci]# vi gitlab-runner/templates/pvc.yaml \r\napiVersion: v1\r\nkind: PersistentVolume\r\nmetadata:\r\n  labels:\r\n    type: local\r\n  name: ci-build-cache-pv\r\n  namespace: gitlab-ci\r\nspec:\r\n  storageClassName: manual\r\n  accessModes:\r\n    - ReadWriteOnce\r\n  capacity:\r\n    storage: 10Gi\r\n  hostPath:\r\n    path: "/opt/ci-build-cache"\r\n---\r\napiVersion: v1\r\nkind: PersistentVolumeClaim\r\nmetadata:\r\n  name: ci-build-cache-pvc\r\n  namespace: gitlab-ci\r\nspec:\r\n  storageClassName: manual\r\n  accessModes:\r\n    - ReadWriteOnce\r\n  resources:\r\n    requests:\r\n      storage: 5Gi\r\n\r\n#\u7f16\u8f91values.yaml\u6587\u4ef6\uff0c\u5728\u6700\u540e\u4e00\u884c\u540e\u6dfb\u52a0\u6784\u5efa\u7f13\u5b58\u4fe1\u606f\u914d\u7f6e\uff1a\r\n[root@master gitlab-ci]# vi gitlab-runner/values.yaml\r\n## configure build cache\r\ncibuild:\r\n  cache:\r\n    pvcName: ci-build-cache-pvc\r\n    mountPath: /home/gitlab-runner/ci-build-cache\r\n\r\n[root@master gitlab-ci]# vi gitlab-runner/templates/configmap.yaml\r\n    cat >>/home/gitlab-runner/.gitlab-runner/config.toml <<EOF\r\n      [[runners.kubernetes.volumes.pvc]]\r\n      name = "{{.Values.cibuild.cache.pvcName}}"\r\n      mount_path = "{{.Values.cibuild.cache.mountPath}}"\r\n    EOF\r\n\r\n    # Start the runner   #\u5728\u8fd9\u4e00\u884c\u4e0a\u9762\u6dfb\u52a0\r\n    exec /entrypoint run --user=gitlab-runner \\\r\n      --working-directory=/home/gitlab-runner\r\n\r\n[root@k8s-master-node1 gitlab-ci]# helm -n gitlab-ci install gitlab-runner gitlab-runner\r\nNAME: gitlab-runner\r\nLAST DEPLOYED: Wed Jan 10 16:46:30 2024\r\nNAMESPACE: gitlab-ci\r\nSTATUS: deployed\r\nREVISION: 1\r\nTEST SUITE: None\r\nNOTES:\r\nYour GitLab Runner should now be registered against the GitLab instance reachable at: "http://172.29.20.207:30880/"\r\n\r\nRunner namespace "gitlab-ci" was found in runners.config template.\n'})}),"\n",(0,a.jsx)(r.p,{children:"#\u53ef\u4ee5\u770b\u5230Runner\u72b6\u6001\u4e3aonline\uff0c\u8868\u660e\u5df2\u7ecf\u6ce8\u518c\u6210\u529f\u3002"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/9",alt:"img"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee8228-\u90e8\u7f72gitlab-agent-10\u5206",children:"\u3010\u9898\u76ee8\u30112.2.8 \u90e8\u7f72GitLab Agent [1.0\u5206]"}),"\n",(0,a.jsx)(r.p,{children:"\u5c06Kubernetes\u96c6\u7fa4\u6dfb\u52a0\u5230demo-2048\u9879\u76ee\u4e2d\uff0c\u5e76\u547d\u540d\u4e3akubernetes-agent\uff0c\u9879\u76ee\u547d\u540d\u7a7a\u95f4\u9009\u62e9gitlab-ci\u3002\u5b8c\u6210\u540e\u63d0\u4ea4master\u8282\u70b9\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801\u548cIP\u5730\u5740\u5230\u7b54\u9898\u6846\u3002\uff08\u9700\u8981\u7528\u5230\u7684\u8f6f\u4ef6\u5305\uff1aCICD-Runner.tar.gz\uff09"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/10",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/11",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/12",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/13",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/14",alt:"img"})]}),"\n",(0,a.jsx)(r.p,{children:"#\u6dfb\u52a0 .gitlab/agents/kubernetes-agent/config.yaml (main \u6dfb\u52a0)\r\n#\u6587\u4ef6\u683c\u5f0f\u5982\u4e0b\uff1a"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",children:"gitops:\r\n  manifest_projects:\r\n  - id: root/demo-2048\r\n    default_namespace: gitlab-ci\r\n    paths:\r\n    - glob: '/**/*.{yaml,yml,json}'\n"})}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/15",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/16",alt:"img"})]}),"\n",(0,a.jsx)(r.p,{children:"#\u521b\u5efa\u5b8c\u5230\u4e0b\u9762\u8fd9\u4e2a\u9875\u9762 \u590d\u5236\u6846\u9009\u7684\u5730\u65b9 \u66f4\u6539\u5b8c\u8fdb\u884c\u6267\u884c"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/17",alt:"img"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 gitlab-ci]# helm upgrade --install kubernetes-agent gitlab-agent-1.1.0.tgz --namespace gitlab-ci  --create-namespace --set image.tag=v16.2.0 --set config.token=PNYDa-ZWshXX1stKHJbu285mprTZiY79spshsbkQ_udGs1HPSA --set config.kasAddress=ws://gitlab-5945f868c9-5gpsn/-/kubernetes-agent/\r\nRelease "kubernetes-agent" does not exist. Installing it now.\r\nNAME: kube4rnetes-agent\r\nLAST DEPLOYED: Wed Jan 10 16:54:54 2024\r\nNAMESPACE: gitlab-ci\r\nSTATUS: deployed\r\nREVISION: 1\r\nTEST SUITE: None\n'})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/18",alt:"img"})}),"\n",(0,a.jsx)(r.h3,{id:"\u9898\u76ee9229-\u6784\u5efacicd-20\u5206",children:"\u3010\u9898\u76ee9\u30112.2.9 \u6784\u5efaCI/CD [2.0\u5206]"}),"\n",(0,a.jsxs)(r.p,{children:["\u7f16\u5199\u6d41\u6c34\u7ebf\u811a\u672c.gitlab-ci.yml\u89e6\u53d1\u81ea\u52a8\u6784\u5efa\uff0c\u5177\u4f53\u8981\u6c42\u5982\u4e0b\uff1a\uff081\uff09\u57fa\u4e8e\u955c\u50cfmaven:3.6-jdk-8\u6784\u5efa\u9879\u76ee\u7684drone\u5206\u652f\uff1b\uff082\uff09\u6784\u5efa\u955c\u50cf\u7684\u540d\u79f0\uff1ademo",":latest","\uff1b\uff083\uff09\u5c06\u955c\u50cf\u63a8\u9001\u5230Harbor\u4ed3\u5e93demo\u9879\u76ee\u4e2d\uff1b\uff084\uff09\u5c06demo-2048\u5e94\u7528\u81ea\u52a8\u53d1\u5e03\u5230Kubernetes\u96c6\u7fa4gitlab-ci\u547d\u540d\u7a7a\u95f4\u4e0b\u3002\u5b8c\u6210\u540e\u63d0\u4ea4master\u8282\u70b9\u7684\u7528\u6237\u540d\u3001\u5bc6\u7801\u548cIP\u5730\u5740\u5230\u7b54\u9898\u6846\u3002\uff08\u9700\u8981\u7528\u5230\u7684\u8f6f\u4ef6\u5305\uff1aCICD-Runner.tar.gz\uff09"]}),"\n",(0,a.jsx)(r.p,{children:"#\u767b\u5f55Harbor\u4ed3\u5e93\u65b0\u5efa\u4e00\u4e2a\u516c\u5f00\u9879\u76eedemo"}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/19",alt:"img"})}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-shell",children:'[root@k8s-master-node1 gitlab-ci]# ctr -n k8s.io images tag docker.io/library/tomcat:8.5.64-jdk8 172.29.20.107/library/tomcat:8.5.64-jdk8\r\n\r\n[root@k8s-master-node1 gitlab-ci]# ctr -n k8s.io images push 172.29.20.107/library/tomcat:8.5.64-jdk8 --plain-http=true --user admin:Harbor12345\r\n\r\n#\u4fee\u6539containerd\u914d\u7f6e\u6587\u4ef6\uff1aworker\u8282\u70b9\u4e5f\u9700\u4fee\u6539\r\n[root@k8s-master-node1 gitlab-ci]# vi /etc/containerd/config.toml \r\n\r\n      [plugins."io.containerd.grpc.v1.cri".registry.mirrors]\r\n        [plugins."io.containerd.grpc.v1.cri".registry.mirrors."172.29.20.107"]\r\n          endpoint = ["http://172.29.20.107"]\r\n\r\n[root@k8s-master-node1 gitlab-ci]# systemctl daemon-reload \r\n\r\n[root@k8s-master-node1 gitlab-ci]# systemctl restart containerd\n'})}),"\n",(0,a.jsx)(r.p,{children:"#\u5207\u6362\u9879\u76ee"}),"\n",(0,a.jsxs)(r.p,{children:[(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/20",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/21",alt:"img"}),(0,a.jsx)(r.br,{}),"\n",(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/22",alt:"img"})]}),"\n",(0,a.jsx)(r.p,{children:"#.gitlab-ci.yml"}),"\n",(0,a.jsx)(r.pre,{children:(0,a.jsx)(r.code,{className:"language-yaml",children:'stages:\r\n  - build\r\n  - release\r\n  - review\r\n\r\nvariables:\r\n  MAVEN_OPTS: "-Dmaven.repo.local=/opt/cache/.m2/repository"\r\n\r\nmaven_build:\r\n  image: maven:3.6-jdk-8\r\n  stage: build\r\n  only:\r\n    - drone\r\n  script:\r\n    - cp -r /opt/repository /opt/cache/.m2/\r\n    - mvn clean install -DskipTests=true\r\n    - cd target && jar -xf 2048.war\r\n    - cp -rfv 2048 /home/gitlab-runner/ci-build-cache\r\n\r\nimage_build:\r\n  image: docker:18.09.7\r\n  stage: release\r\n  variables:\r\n    DOCKER_DRIVER: overlay\r\n    DOCKER_HOST: tcp://localhost:2375\r\n    #CI_DEBUG_TRACE: "true"\r\n  services:\r\n    - name: docker:18.09.7-dind\r\n      command: ["--insecure-registry=0.0.0.0/0"]\r\n  script:\r\n    - cp -rfv /home/gitlab-runner/ci-build-cache/2048 .\r\n    - docker build -t demo:latest -f ./Dockerfiles/Dockerfile .\r\n    - docker tag demo:latest 172.29.20.103/demo/demo:latest   #IP\u66f4\u6362\u4e3a\u672c\u673aIP\r\n    - docker login -u admin -p Harbor12345 172.29.20.103\r\n    - docker push 172.29.20.103/demo/demo:latest\r\n \r\ndeploy_review:\r\n  image: kubectl:1.22\r\n  stage: review\r\n  only:\r\n    - drone\r\n  script:\r\n    - kubectl apply -f template/\n'})}),"\n",(0,a.jsx)(r.p,{children:(0,a.jsx)(r.img,{src:"http://miragedge.top/assets/images/md/23",alt:"img"})})]})}function m(e={}){const{wrapper:r}={...(0,s.R)(),...e.components};return r?(0,a.jsx)(r,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>i,x:()=>o});var t=n(6540);const a={},s=t.createContext(a);function i(e){const r=t.useContext(s);return t.useMemo((function(){return"function"==typeof e?e(r):{...r,...e}}),[r,e])}function o(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:i(e.components),t.createElement(s.Provider,{value:r},e.children)}}}]);